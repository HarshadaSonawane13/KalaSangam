<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Registrations | KalaSangam</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
</head>

<body>
  <!-- Header -->
  <header>
    <nav class="navbar navbar-expand-lg custom-navbar">
      <div class="container">
        <a class="navbar-brand" href="index.html">
          <span class="logo-text">KalaSangam</span>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item"><a class="nav-link" href="dashboard.html">Dashboard</a></li>
            <li class="nav-item"><a id="logoutBtn" class="btn btn-sm btn-login" href="#">Logout</a></li>
          </ul>
        </div>
      </div>
    </nav>
  </header>

  <!-- My Registrations Section -->
  <section class="py-5">
    <div class="container">
      <h2 class="text-center mb-4">My Workshop Registrations</h2>
      <div class="table-responsive">
        <table class="table table-bordered table-striped text-center align-middle">
          <thead class="table-dark">
            <tr>
              <th>#</th>
              <th>Workshop Title</th>
              <th>Category</th>
              <th>Event Date</th>
              <th>Preferred Date</th>
              <th>Notes</th>
              <th>Registered On</th>
            </tr>
          </thead>
          <tbody id="registrationsTableBody">
            <tr><td colspan="7">Loading your registrations...</td></tr>
          </tbody>
        </table>
      </div>
      <div class="text-center mt-4">
        <a href="dashboard.html" class="btn btn-cta">Back to Dashboard</a>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="footer py-3 text-center mt-auto">
    <div class="container">
      <p class="mb-1">Join Our Creative Community</p>
      <p class="mb-0"><a href="#">Privacy Policy</a> | &copy; 2025 KalaSangam</p>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const token = localStorage.getItem('token');
      const username = localStorage.getItem('username');

      if (!token || !username) {
        alert('Please log in first!');
        window.location.href = 'login.html';
        return;
      }

      const tableBody = document.getElementById('registrationsTableBody');

      try {
        const res = await fetch('http://localhost:5000/api/registrations/my', {
          headers: { 'Authorization': 'Bearer ' + token }
        });

        if (!res.ok) throw new Error('Failed to fetch data');

        const data = await res.json();

        if (data.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="7">You have not registered for any workshops yet.</td></tr>';
          return;
        }

        tableBody.innerHTML = data.map((r, i) => `
          <tr>
            <td>${i + 1}</td>
            <td>${r.event_title}</td>
            <td>${r.event_category}</td>
            <td>${new Date(r.event_date).toLocaleDateString()}</td>
            <td>${r.preferred_date ? new Date(r.preferred_date).toLocaleDateString() : '-'}</td>
            <td>${r.notes || '-'}</td>
            <td>${new Date(r.created_at).toLocaleDateString()}</td>
          </tr>
        `).join('');
      } catch (err) {
        console.error(err);
        tableBody.innerHTML = '<tr><td colspan="7">Error loading registrations.</td></tr>';
      }

      document.getElementById('logoutBtn').addEventListener('click', (e) => {
        e.preventDefault();
        ['token', 'username', 'role'].forEach(k => localStorage.removeItem(k));
        alert('You have been logged out.');
        window.location.href = 'index.html';
      });
    });
  </script>
</body>
</html>
