<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard | KalaSangam</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <!-- Sidebar -->
  <div class="sidebar">
    <h3>KalaSangam Admin</h3>
    <a href="#" class="active" id="registrationsTabBtn">ðŸ§¾ Registrations</a>
    <a href="#" id="messagesTabBtn">ðŸ’¬ Contact Messages</a>
    <a href="#" id="eventsTabBtn">ðŸŽ¨ Manage Events</a>
    <button class="logout-btn" id="logoutBtn">Logout</button>
  </div>

  <!-- Content -->
  <div class="content">
    <h2 class="mb-4">Dashboard Overview</h2>

    <div class="dashboard-cards">
      <div class="card-stat">
        <h4>Total Users</h4>
        <span id="totalUsers">0</span>
      </div>
      <div class="card-stat">
        <h4>Total Registrations</h4>
        <span id="totalRegistrations">0</span>
      </div>
      <div class="card-stat">
        <h4>Total Messages</h4>
        <span id="totalMessages">0</span>
      </div>
    </div>

    <!-- Registrations -->
    <div id="registrationsTab">
      <h3 class="mb-3">All Registrations</h3>
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>User</th>
            <th>Event</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Date</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="registrationsTableBody">
          <tr><td colspan="7">Loading...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Contact Messages -->
    <div id="messagesTab" style="display:none;">
      <h3 class="mb-3">Contact Messages</h3>
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Email</th>
            <th>Message</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="messagesTableBody">
          <tr><td colspan="5">Loading...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Events Management -->
    <div id="eventsTab" style="display:none;">
      <h3 class="mb-3">Manage Events</h3>

      <!-- Add Event Form -->
      <form id="addEventForm" class="mb-4">
        <div class="row g-2">
          <div class="col-md-3">
            <input type="text" id="eventTitle" class="form-control" placeholder="Event Title" required>
          </div>
          <div class="col-md-2">
            <input type="text" id="eventCategory" class="form-control" placeholder="Category" required>
          </div>
          <div class="col-md-2">
            <input type="date" id="eventDate" class="form-control" required>
          </div>
          <div class="col-md-3">
            <input type="text" id="eventImage" class="form-control" placeholder="Image URL">
          </div>
          <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">Add Event</button>
          </div>
        </div>
        <textarea id="eventDescription" class="form-control mt-2" rows="2" placeholder="Description"></textarea>
      </form>

      <!-- Events Table -->
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Title</th>
            <th>Category</th>
            <th>Date</th>
            <th>Image</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="eventsTableBody">
          <tr><td colspan="6">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const token = localStorage.getItem('token');
    if (!token) {
      alert('Unauthorized. Please log in as admin.');
      window.location.href = 'login.html';
    }

    const headers = { 'Authorization': 'Bearer ' + token };

    // ðŸ§® Fetch Dashboard Data
    async function fetchDashboardData() {
      try {
        const [regRes, msgRes] = await Promise.all([
          fetch('http://localhost:5000/api/registrations', { headers }),
          fetch('http://localhost:5000/api/admin/contact', { headers })
        ]);

        const registrations = await regRes.json();
        const messages = await msgRes.json();

        document.getElementById('totalRegistrations').textContent = registrations.length;
        document.getElementById('totalMessages').textContent = messages.length;

        const usersSet = new Set(registrations.map(r => r.user_name));
        document.getElementById('totalUsers').textContent = usersSet.size;

        const regTable = document.getElementById('registrationsTableBody');
        regTable.innerHTML = registrations.map(r => `
          <tr>
            <td>${r.registration_id}</td>
            <td>${r.user_name || 'â€”'}</td>
            <td>${r.event_title || 'â€”'}</td>
            <td>${r.user_email || 'â€”'}</td>
            <td>${r.user_phone || 'â€”'}</td>
            <td>${r.preferred_date ? new Date(r.preferred_date).toLocaleDateString() : 'â€”'}</td>
            <td><button class="btn btn-danger btn-sm" onclick="deleteRegistration(${r.registration_id})">Delete</button></td>
          </tr>
        `).join('');

        const msgTable = document.getElementById('messagesTableBody');
        msgTable.innerHTML = messages.map(m => `
          <tr>
            <td>${m.id}</td>
            <td>${m.name}</td>
            <td>${m.email}</td>
            <td>${m.message}</td>
            <td><button class="btn btn-danger btn-sm" onclick="deleteMessage(${m.id})">Delete</button></td>
          </tr>
        `).join('');
      } catch (err) {
        console.error('Error loading dashboard:', err);
        alert('Error loading data');
      }
    }

    // Delete Registration
    async function deleteRegistration(id) {
      if (!confirm('Delete this registration?')) return;
      await fetch(`http://localhost:5000/api/registrations/${id}`, { method: 'DELETE', headers });
      fetchDashboardData();
    }

    // Delete Message
    async function deleteMessage(id) {
      if (!confirm('Delete this message?')) return;
      await fetch(`http://localhost:5000/api/admin/contact/${id}`, { method: 'DELETE', headers });
      fetchDashboardData();
    }

    // ================== ðŸ—‚ EVENT MANAGEMENT ==================
    async function fetchEvents() {
      try {
        const res = await fetch('http://localhost:5000/api/events');
        const events = await res.json();
        const tableBody = document.getElementById('eventsTableBody');
        tableBody.innerHTML = events.map(e => `
          <tr>
            <td>${e.id}</td>
            <td>${e.title}</td>
            <td>${e.category}</td>
            <td>${e.date}</td>
            <td><img src="${e.image || ''}" alt="event" width="50"></td>
            <td>
              <button class="btn btn-sm btn-warning" onclick="editEvent(${e.id})">Edit</button>
              <button class="btn btn-sm btn-danger" onclick="deleteEvent(${e.id})">Delete</button>
            </td>
          </tr>
        `).join('');
      } catch (err) {
        console.error(err);
        alert('Error loading events');
      }
    }

    // âž• Add Event
    document.getElementById('addEventForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const newEvent = {
        title: document.getElementById('eventTitle').value,
        category: document.getElementById('eventCategory').value,
        date: document.getElementById('eventDate').value,
        description: document.getElementById('eventDescription').value,
        image: document.getElementById('eventImage').value
      };

      const res = await fetch('http://localhost:5000/api/events', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(newEvent)
      });

      if (res.ok) {
        alert('Event added!');
        e.target.reset();
        fetchEvents();
      } else {
        alert('Failed to add event');
      }
    });

    // âœï¸ Edit Event
    async function editEvent(id) {
      const newTitle = prompt('Enter new title:');
      if (!newTitle) return;

      const res = await fetch(`http://localhost:5000/api/events/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title: newTitle })
      });

      if (res.ok) {
        alert('Event updated!');
        fetchEvents();
      } else {
        alert('Update failed');
      }
    }

    // âŒ Delete Event
    async function deleteEvent(id) {
      if (!confirm('Are you sure you want to delete this event?')) return;
      const res = await fetch(`http://localhost:5000/api/events/${id}`, { method: 'DELETE' });
      if (res.ok) {
        alert('Event deleted!');
        fetchEvents();
      } else {
        alert('Failed to delete event');
      }
    }

    // ðŸ§­ Tab Switching
    document.getElementById('registrationsTabBtn').addEventListener('click', () => {
      document.getElementById('registrationsTab').style.display = 'block';
      document.getElementById('messagesTab').style.display = 'none';
      document.getElementById('eventsTab').style.display = 'none';
    });

    document.getElementById('messagesTabBtn').addEventListener('click', () => {
      document.getElementById('registrationsTab').style.display = 'none';
      document.getElementById('messagesTab').style.display = 'block';
      document.getElementById('eventsTab').style.display = 'none';
    });

    document.getElementById('eventsTabBtn').addEventListener('click', () => {
      document.getElementById('registrationsTab').style.display = 'none';
      document.getElementById('messagesTab').style.display = 'none';
      document.getElementById('eventsTab').style.display = 'block';
      fetchEvents();
    });

    // ðŸšª Logout
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('token');
      alert('Logged out successfully!');
      window.location.href = 'login.html';
    });

    fetchDashboardData();
  </script>
</body>
</html>
